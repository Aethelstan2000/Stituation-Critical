<Window x:Class="PixelStitch.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:PixelStitch"
        x:Name="Root"
        Title="PixelStitch - Pixel Art &amp; DMC Palette" Height="800" Width="1200">

    <!-- Undo/Redo command wiring -->
    <Window.CommandBindings>
        <CommandBinding Command="ApplicationCommands.Undo" Executed="Undo_Executed" CanExecute="Undo_CanExecute"/>
        <CommandBinding Command="ApplicationCommands.Redo" Executed="Redo_Executed" CanExecute="Redo_CanExecute"/>
    </Window.CommandBindings>
    <Window.InputBindings>
        <KeyBinding Command="ApplicationCommands.Undo" Modifiers="Control" Key="Z"/>
        <KeyBinding Command="ApplicationCommands.Redo" Modifiers="Control" Key="Y"/>
        <KeyBinding Command="ApplicationCommands.Redo" Modifiers="Control+Shift" Key="Z"/>
    </Window.InputBindings>

    <DockPanel>
        <!-- ===== Toolbar: two lines ===== -->
        
        <ToolBarTray DockPanel.Dock="Top">
            <!-- Line 1 -->
            <ToolBar Band="0" BandIndex="0">
                <StackPanel Orientation="Vertical" VerticalAlignment="Center" Margin="6,0,6,0">
                    <!-- Header centered over this group -->
                    <TextBlock Text="File" HorizontalAlignment="Center" FontSize="11" Margin="0,0,0,2"/>
                    <StackPanel Orientation="Vertical" VerticalAlignment="Center" Margin="4,4,4,4">
                        <Button Click="NewCanvas_Click"  Height="20" Margin="0,0,0,4" ToolTip="Start a new project">New</Button>
                        <Button Click="SaveProject_Click" Height="20" Margin="0,0,0,4" ToolTip="Save current project">Save</Button>
                        <Button Click="LoadProject_Click" Height="20" ToolTip="Load a project">Load</Button>
                    </StackPanel>
                </StackPanel>
                <Separator/>

                <!-- Canvas group: header above, controls below -->
                <StackPanel Orientation="Vertical" VerticalAlignment="Center" Margin="6,0,6,0">
                    <!-- Header centered over this group -->
                    <TextBlock Text="Canvas Size" HorizontalAlignment="Center" FontSize="11" Margin="0,0,0,2"/>

                    <!-- Your existing controls laid out horizontally -->
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <!-- Canvas size fields stacked (Grid) -->
                        <Grid Margin="0,0,6,0" VerticalAlignment="Center">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <!-- label -->
                                <ColumnDefinition Width="*"/>
                                <!-- textbox -->
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Text="W:" Grid.Row="0" Grid.Column="0"
                 VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBox Name="WidthBox" Grid.Row="0" Grid.Column="1"
               Width="50" Text="64"/>

                            <TextBlock Text="H:" Grid.Row="1" Grid.Column="0"
                 VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBox Name="HeightBox" Grid.Row="1" Grid.Column="1"
               Width="50" Text="64"/>
                        </Grid>

                        <!-- Anchor picker -->
                        <StackPanel Orientation="Vertical" Margin="6,0,6,0" VerticalAlignment="Center">
                            <TextBlock Text="Anchor" HorizontalAlignment="Center"/>
                            <UniformGrid Rows="3" Columns="3" Margin="0,2,0,0">
                                <RadioButton Width="18" Height="18" Tag="TopLeft"    Checked="Anchor_Checked" GroupName="AnchorBtns" ToolTip="Top-Left"/>
                                <RadioButton Width="18" Height="18" Tag="Top"        Checked="Anchor_Checked" GroupName="AnchorBtns" ToolTip="Top"/>
                                <RadioButton Width="18" Height="18" Tag="TopRight"   Checked="Anchor_Checked" GroupName="AnchorBtns" ToolTip="Top-Right"/>
                                <RadioButton Width="18" Height="18" Tag="Left"       Checked="Anchor_Checked" GroupName="AnchorBtns" ToolTip="Left"/>
                                <RadioButton Width="18" Height="18" Tag="Center"     Checked="Anchor_Checked" GroupName="AnchorBtns" IsChecked="True" ToolTip="Center"/>
                                <RadioButton Width="18" Height="18" Tag="Right"      Checked="Anchor_Checked" GroupName="AnchorBtns" ToolTip="Right"/>
                                <RadioButton Width="18" Height="18" Tag="BottomLeft" Checked="Anchor_Checked" GroupName="AnchorBtns" ToolTip="Bottom-Left"/>
                                <RadioButton Width="18" Height="18" Tag="Bottom"     Checked="Anchor_Checked" GroupName="AnchorBtns" ToolTip="Bottom"/>
                                <RadioButton Width="18" Height="18" Tag="BottomRight" Checked="Anchor_Checked" GroupName="AnchorBtns" ToolTip="Bottom-Right"/>
                            </UniformGrid>
                        </StackPanel>

                        <!-- Resize button -->
                        <Button Click="ResizeCanvas_Click" Height="20" VerticalAlignment="Center"
            ToolTip="Resize canvas to W × H using anchor">Resize</Button>
                    </StackPanel>
                </StackPanel>

                <Separator/>
                <!--StackPanel Orientation="Vertical" VerticalAlignment="Center" Margin="6,0,6,0"-->
                    <!-- Header centered over this group -->
                    <TextBlock Text="Canvas Options" HorizontalAlignment="Center" FontSize="11" Margin="0,0,0,2"/>
                    <!-- Reference controls: 3 tidy rows -->
                    <StackPanel Orientation="Vertical" VerticalAlignment="Center" Margin="10,0,10,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <!-- buttons -->
                                <RowDefinition Height="Auto"/>
                                <!-- ref opacity -->
                                <RowDefinition Height="Auto"/>
                                <!-- canvas opacity -->
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <!-- labels -->
                                <ColumnDefinition Width="100"/>
                                <!-- sliders -->
                            </Grid.ColumnDefinitions>

                            <!-- Row 0: buttons -->
                            <StackPanel Grid.Row="0" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,0,0,4">
                                <ToggleButton Name="GridCheck" IsChecked="True" Margin="6,0">Show Grid</ToggleButton>
                                <!--Button Click="LoadRefImage_Click" Height="22" ToolTip="Load a background image to trace">Load Reference</Button-->
                                <ToggleButton Name="ShowRefCheck" IsChecked="True" Margin="8,0,0,0" ToolTip="Toggles visibility of reference image">Show Ref</ToggleButton>
                            </StackPanel>

                            <!-- Row 1: Ref opacity -->
                            <TextBlock Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,6,0" Text="Ref Opacity:"/>
                            <Slider   Name="RefOpacitySlider" Grid.Row="1" Grid.Column="1" Minimum="0" Maximum="1" Value="0.6" TickFrequency="0.1" IsSnapToTickEnabled="True" Height="20" Width="100"/>

                            <!-- Row 2: Canvas opacity -->
                            <TextBlock Grid.Row="2" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,6,0" Text="Canvas Opacity:"/>
                            <Slider   Name="CanvasOpacitySlider" Grid.Row="2" Grid.Column="1" Minimum="0" Maximum="1" Value="1" TickFrequency="0.1" IsSnapToTickEnabled="True" Height="20" Width="100"/>
                            <TextBlock Grid.Row="3" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,6,0" Text="Zoom:"/>
                            <Slider Name="ZoomSlider" Grid.Row="3" Grid.Column="1" Width="100" Minimum="1" Maximum="40" Value="12" TickFrequency="1"
                            IsSnapToTickEnabled="True" ValueChanged="ZoomSlider_ValueChanged"/>
                        </Grid>
                    </StackPanel>
                
                <StackPanel Orientation="Vertical" VerticalAlignment="Center" Margin="10,4,10,4">
                        <Button Click="LoadRefImage_Click" Height="20" Margin="0,0,0,4" ToolTip="Load a background image to trace">Load Reference</Button>
                        <Button Click="ClearCanvas_Click" Height="20" Margin="0,0,0,4" ToolTip="Clears the pixel canvas">Clear canvas</Button>
                        <Button Click="ImportPngToCanvas_Click" Height="20" Margin="0,0,0,4" ToolTip="Import an image and quantise to DMC">Import PNG → Canvas</Button>
                        <Button Click="SavePng_Click" Height="20" Margin="0,0,0,4" ToolTip="Exports the canvas to PNG">Export Canvas → PNG</Button>
                    </StackPanel>
               <!--/StackPanel-->
                <Separator/>



                <TextBlock Margin="6,0">Max Colours:</TextBlock>
                <TextBox Name="MaxColoursBox" Width="40" Text="16" Margin="4,0"/>
                <CheckBox Name="UseActiveForReduce" Margin="6,0">Use Active</CheckBox>
                <Button Click="ReduceColours_Click" ToolTip="Remap canvas to Max Colours">Reduce</Button>
                <Separator/>
                <Button Click="ReassignSymbols_Click">Reassign Symbols</Button>
                <Button Click="TestBuildPattern_Click">Test Pattern Export</Button>
            </ToolBar>
        </ToolBarTray>

        <!-- ===== Resizable layout: palettes | splitter | canvas ===== -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="420" MinWidth="240"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left: palettes -->
            <Grid Grid.Column="0">
                <TabControl Name="PaletteTabs">
                    <!-- ===== Global DMC tab ===== -->
                    <TabItem Header="Global DMC">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition/>
                            </Grid.RowDefinitions>
                            <StackPanel Orientation="Horizontal" Margin="6">
                                <TextBox Name="PaletteFilterBox" Width="220" Margin="0,0,6,0" TextChanged="PaletteFilterBox_TextChanged"/>
                                <Button Click="ResetFilter_Click">Reset</Button>
                                <Button Margin="6,0,0,0" Click="AddSelectedToActive_Click">Add ➝ Active</Button>
                            </StackPanel>
                            <ListView Name="PaletteList" Grid.Row="1" SelectionChanged="PaletteList_SelectionChanged">
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn Header="Swatch" Width="60">
                                            <GridViewColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Border Width="40" Height="20" BorderBrush="Black" BorderThickness="1">
                                                        <Border.Background>
                                                            <SolidColorBrush Color="{Binding Color}"/>
                                                        </Border.Background>
                                                    </Border>
                                                </DataTemplate>
                                            </GridViewColumn.CellTemplate>
                                        </GridViewColumn>
                                        <GridViewColumn Header="Code" DisplayMemberBinding="{Binding Code}" Width="70"/>
                                        <GridViewColumn Header="Name" DisplayMemberBinding="{Binding Name}" Width="240"/>
                                    </GridView>
                                </ListView.View>
                            </ListView>
                        </Grid>
                    </TabItem>

                    <!-- ===== Active Palette tab ===== -->
                    <TabItem Header="Active Palette">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <StackPanel Orientation="Horizontal" Margin="6">
                                <Button Click="RemoveSelectedActive_Click">Remove</Button>
                                <Button Margin="6,0,0,0" Click="ClearActive_Click">Clear</Button>
                                <Button Margin="6,0,0,0" Click="ActiveFromCanvas_Click">From Canvas (Top N)</Button>
                                <Button Margin="6,0,0,0" Click="MergeSelected_Click">Merge Selected</Button>
                            </StackPanel>

                            <ListView Name="ActiveList" Grid.Row="1" SelectionChanged="ActiveList_SelectionChanged" SelectionMode="Extended">
                                <ListView.View>
                                    <GridView>
                                        <!-- Symbol dropdown -->
                                        <GridViewColumn Header="Sym" Width="50">
                                            <GridViewColumn.CellTemplate>
                                                <DataTemplate>
                                                    <ComboBox Width="44"
                                                              ItemsSource="{Binding ElementName=Root, Path=SymbolChoices}"
                                                              SelectedItem="{Binding Symbol, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                              SelectionChanged="SymbolCombo_SelectionChanged"/>
                                                </DataTemplate>
                                            </GridViewColumn.CellTemplate>
                                        </GridViewColumn>
                                        <!-- Swatch -->
                                        <GridViewColumn Header="Swatch" Width="60">
                                            <GridViewColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Border Width="40" Height="20" BorderBrush="Black" BorderThickness="1">
                                                        <Border.Background>
                                                            <SolidColorBrush Color="{Binding Color}"/>
                                                        </Border.Background>
                                                    </Border>
                                                </DataTemplate>
                                            </GridViewColumn.CellTemplate>
                                        </GridViewColumn>
                                        <GridViewColumn Header="Code" DisplayMemberBinding="{Binding Code}" Width="70"/>
                                        <GridViewColumn Header="Name" DisplayMemberBinding="{Binding Name}" Width="180"/>
                                        <!-- Count column (requires DmcColor.Count int) -->
                                        <GridViewColumn Header="Count" DisplayMemberBinding="{Binding Count}" Width="70"/>
                                    </GridView>
                                </ListView.View>
                            </ListView>

                            <!-- Active colour indicator -->
                            <Border Grid.Row="2" Padding="8" BorderBrush="Gainsboro" BorderThickness="1">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Active:" Margin="0,0,8,0"/>
                                    <Border Width="30" Height="20" BorderBrush="Black" BorderThickness="1" Margin="0,0,8,0">
                                        <Border.Background>
                                            <SolidColorBrush x:Name="ActiveBrush" Color="Black"/>
                                        </Border.Background>
                                    </Border>
                                    <TextBlock Name="ActiveLabel" Text="DMC 310 Black"/>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </TabItem>
                </TabControl>
            </Grid>

            <!-- Splitter -->
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch"
                          Background="#303030" ShowsPreview="True" />

            <!-- Right: canvas in scroll viewer -->
            <ScrollViewer x:Name="CanvasScroll"
                          Grid.Column="2"
                          HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Auto"
                          Background="#FF2B2B2B">
                <Grid>
                    <local:PixelCanvas x:Name="Canvas" Margin="10"
                                       PixelGridVisible="{Binding ElementName=GridCheck, Path=IsChecked}"
                                       ReferenceOpacity="{Binding ElementName=RefOpacitySlider, Path=Value}"
                                       ReferenceVisible="{Binding ElementName=ShowRefCheck, Path=IsChecked}"
                                       PixelLayerOpacity="{Binding ElementName=CanvasOpacitySlider, Path=Value}"/>
                </Grid>
            </ScrollViewer>
        </Grid>
    </DockPanel>
</Window>
